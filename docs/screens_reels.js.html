<!DOCTYPE html><html lang="en" style="font-size:16px"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Source: screens/reels.js</title><!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]--><script src="scripts/third-party/hljs.js" defer="defer"></script><script src="scripts/third-party/hljs-line-num.js" defer="defer"></script><script src="scripts/third-party/popper.js" defer="defer"></script><script src="scripts/third-party/tippy.js" defer="defer"></script><script src="scripts/third-party/tocbot.min.js"></script><script>var baseURL="/",locationPathname="";baseURL=(locationPathname=document.location.pathname).substr(0,locationPathname.lastIndexOf("/")+1)</script><link rel="stylesheet" href="styles/clean-jsdoc-theme.min.css"><svg aria-hidden="true" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" style="display:none"><defs><symbol id="copy-icon" viewbox="0 0 488.3 488.3"><g><path d="M314.25,85.4h-227c-21.3,0-38.6,17.3-38.6,38.6v325.7c0,21.3,17.3,38.6,38.6,38.6h227c21.3,0,38.6-17.3,38.6-38.6V124    C352.75,102.7,335.45,85.4,314.25,85.4z M325.75,449.6c0,6.4-5.2,11.6-11.6,11.6h-227c-6.4,0-11.6-5.2-11.6-11.6V124    c0-6.4,5.2-11.6,11.6-11.6h227c6.4,0,11.6,5.2,11.6,11.6V449.6z"/><path d="M401.05,0h-227c-21.3,0-38.6,17.3-38.6,38.6c0,7.5,6,13.5,13.5,13.5s13.5-6,13.5-13.5c0-6.4,5.2-11.6,11.6-11.6h227    c6.4,0,11.6,5.2,11.6,11.6v325.7c0,6.4-5.2,11.6-11.6,11.6c-7.5,0-13.5,6-13.5,13.5s6,13.5,13.5,13.5c21.3,0,38.6-17.3,38.6-38.6    V38.6C439.65,17.3,422.35,0,401.05,0z"/></g></symbol><symbol id="search-icon" viewBox="0 0 512 512"><g><g><path d="M225.474,0C101.151,0,0,101.151,0,225.474c0,124.33,101.151,225.474,225.474,225.474    c124.33,0,225.474-101.144,225.474-225.474C450.948,101.151,349.804,0,225.474,0z M225.474,409.323    c-101.373,0-183.848-82.475-183.848-183.848S124.101,41.626,225.474,41.626s183.848,82.475,183.848,183.848    S326.847,409.323,225.474,409.323z"/></g></g><g><g><path d="M505.902,476.472L386.574,357.144c-8.131-8.131-21.299-8.131-29.43,0c-8.131,8.124-8.131,21.306,0,29.43l119.328,119.328    c4.065,4.065,9.387,6.098,14.715,6.098c5.321,0,10.649-2.033,14.715-6.098C514.033,497.778,514.033,484.596,505.902,476.472z"/></g></g></symbol><symbol id="font-size-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M11.246 15H4.754l-2 5H.6L7 4h2l6.4 16h-2.154l-2-5zm-.8-2L8 6.885 5.554 13h4.892zM21 12.535V12h2v8h-2v-.535a4 4 0 1 1 0-6.93zM19 18a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"/></symbol><symbol id="add-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M11 11V5h2v6h6v2h-6v6h-2v-6H5v-2z"/></symbol><symbol id="minus-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M5 11h14v2H5z"/></symbol><symbol id="dark-theme-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M10 7a7 7 0 0 0 12 4.9v.1c0 5.523-4.477 10-10 10S2 17.523 2 12 6.477 2 12 2h.1A6.979 6.979 0 0 0 10 7zm-6 5a8 8 0 0 0 15.062 3.762A9 9 0 0 1 8.238 4.938 7.999 7.999 0 0 0 4 12z"/></symbol><symbol id="light-theme-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M12 18a6 6 0 1 1 0-12 6 6 0 0 1 0 12zm0-2a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM11 1h2v3h-2V1zm0 19h2v3h-2v-3zM3.515 4.929l1.414-1.414L7.05 5.636 5.636 7.05 3.515 4.93zM16.95 18.364l1.414-1.414 2.121 2.121-1.414 1.414-2.121-2.121zm2.121-14.85l1.414 1.415-2.121 2.121-1.414-1.414 2.121-2.121zM5.636 16.95l1.414 1.414-2.121 2.121-1.414-1.414 2.121-2.121zM23 11v2h-3v-2h3zM4 11v2H1v-2h3z"/></symbol><symbol id="reset-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M18.537 19.567A9.961 9.961 0 0 1 12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10c0 2.136-.67 4.116-1.81 5.74L17 12h3a8 8 0 1 0-2.46 5.772l.997 1.795z"/></symbol><symbol id="down-icon" viewBox="0 0 16 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M12.7803 6.21967C13.0732 6.51256 13.0732 6.98744 12.7803 7.28033L8.53033 11.5303C8.23744 11.8232 7.76256 11.8232 7.46967 11.5303L3.21967 7.28033C2.92678 6.98744 2.92678 6.51256 3.21967 6.21967C3.51256 5.92678 3.98744 5.92678 4.28033 6.21967L8 9.93934L11.7197 6.21967C12.0126 5.92678 12.4874 5.92678 12.7803 6.21967Z"></path></symbol><symbol id="codepen-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M16.5 13.202L13 15.535v3.596L19.197 15 16.5 13.202zM14.697 12L12 10.202 9.303 12 12 13.798 14.697 12zM20 10.869L18.303 12 20 13.131V10.87zM19.197 9L13 4.869v3.596l3.5 2.333L19.197 9zM7.5 10.798L11 8.465V4.869L4.803 9 7.5 10.798zM4.803 15L11 19.131v-3.596l-3.5-2.333L4.803 15zM4 13.131L5.697 12 4 10.869v2.262zM2 9a1 1 0 0 1 .445-.832l9-6a1 1 0 0 1 1.11 0l9 6A1 1 0 0 1 22 9v6a1 1 0 0 1-.445.832l-9 6a1 1 0 0 1-1.11 0l-9-6A1 1 0 0 1 2 15V9z"/></symbol><symbol id="close-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M12 10.586l4.95-4.95 1.414 1.414-4.95 4.95 4.95 4.95-1.414 1.414-4.95-4.95-4.95 4.95-1.414-1.414 4.95-4.95-4.95-4.95L7.05 5.636z"/></symbol><symbol id="menu-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M3 4h18v2H3V4zm0 7h18v2H3v-2zm0 7h18v2H3v-2z"/></symbol></defs></svg></head><body data-theme="dark"><div class="sidebar-container"><div class="sidebar" id="sidebar"><a href="/" class="sidebar-title sidebar-title-anchor">LOGOS Documentation</a><div class="sidebar-items-container"><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-modules"><div>Modules</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="module-Screens_Library.html">Screens/Library</a></div><div class="sidebar-section-children"><a href="module-Screens_Login.html">Screens/Login</a></div><div class="sidebar-section-children"><a href="module-Screens_Philosophers.html">Screens/Philosophers</a></div><div class="sidebar-section-children"><a href="module-Screens_Play.html">Screens/Play</a></div><div class="sidebar-section-children"><a href="module-Screens_Reels.html">Screens/Reels</a></div><div class="sidebar-section-children"><a href="module-Screens_SchoolMembers.html">Screens/SchoolMembers</a></div><div class="sidebar-section-children"><a href="module-Screens_Schools.html">Screens/Schools</a></div><div class="sidebar-section-children"><a href="module-Screens_Shop.html">Screens/Shop</a></div><div class="sidebar-section-children"><a href="module-Screens_Symposium.html">Screens/Symposium</a></div><div class="sidebar-section-children"><a href="module-Services_Auth.html">Services/Auth</a></div><div class="sidebar-section-children"><a href="module-Services_Database.html">Services/Database</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-classes"><div>Classes</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="Card.html">Card</a></div><div class="sidebar-section-children"><a href="Modal.html">Modal</a></div><div class="sidebar-section-children"><a href="Player.html">Player</a></div><div class="sidebar-section-children"><a href="PopupManager.html">PopupManager</a></div><div class="sidebar-section-children"><a href="Toast.html">Toast</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-namespaces"><div>Namespaces</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="AnimationsModule.html">AnimationsModule</a></div><div class="sidebar-section-children"><a href="Data.html">Data</a></div><div class="sidebar-section-children"><a href="Data.html">Data</a></div><div class="sidebar-section-children"><a href="Data.html">Data</a></div><div class="sidebar-section-children"><a href="Data.html">Data</a></div><div class="sidebar-section-children"><a href="Data.html">Data</a></div><div class="sidebar-section-children"><a href="Data.html">Data</a></div><div class="sidebar-section-children"><a href="Data.html">Data</a></div><div class="sidebar-section-children"><a href="Data.html">Data</a></div><div class="sidebar-section-children"><a href="Data.html">Data</a></div><div class="sidebar-section-children"><a href="EngineModule.html">EngineModule</a></div><div class="sidebar-section-children"><a href="EventsModule.html">EventsModule</a></div><div class="sidebar-section-children"><a href="GameUI.html">GameUI</a></div><div class="sidebar-section-children"><a href="Popups.html">Popups</a></div><div class="sidebar-section-children"><a href="RendererModule.html">RendererModule</a></div><div class="sidebar-section-children"><a href="StateModule.html">StateModule</a></div><div class="sidebar-section-children"><a href="Utils.html">Utils</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-global"><div>Global</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="global.html#ArenaTimelinePopup">ArenaTimelinePopup</a></div><div class="sidebar-section-children"><a href="global.html#ChestInfoPopup">ChestInfoPopup</a></div><div class="sidebar-section-children"><a href="global.html#ChestRewardsPopup">ChestRewardsPopup</a></div><div class="sidebar-section-children"><a href="global.html#DESKTOP_BREAKPOINT">DESKTOP_BREAKPOINT</a></div><div class="sidebar-section-children"><a href="global.html#FullProfilePopup">FullProfilePopup</a></div><div class="sidebar-section-children"><a href="global.html#LevelXpPopup">LevelXpPopup</a></div><div class="sidebar-section-children"><a href="global.html#PhilosopherDetailsPopup">PhilosopherDetailsPopup</a></div><div class="sidebar-section-children"><a href="global.html#PhilosopherStudyModulePopup">PhilosopherStudyModulePopup</a></div><div class="sidebar-section-children"><a href="global.html#ReelsSettingsPopup">ReelsSettingsPopup</a></div><div class="sidebar-section-children"><a href="global.html#SCHOOLS">SCHOOLS</a></div><div class="sidebar-section-children"><a href="global.html#SettingsPopup">SettingsPopup</a></div><div class="sidebar-section-children"><a href="global.html#TimedChestInfoPopup">TimedChestInfoPopup</a></div><div class="sidebar-section-children"><a href="global.html#handleResize">handleResize</a></div><div class="sidebar-section-children"><a href="global.html#initLayoutManager">initLayoutManager</a></div><div class="sidebar-section-children"><a href="global.html#isDesktopView">isDesktopView</a></div><div class="sidebar-section-children"><a href="global.html#preloadAdjacentImages">preloadAdjacentImages</a></div><div class="sidebar-section-children"><a href="global.html#renderMembers">renderMembers</a></div><div class="sidebar-section-children"><a href="global.html#renderPosts">renderPosts</a></div><div class="sidebar-section-children"><a href="global.html#renderReels">renderReels</a></div><div class="sidebar-section-children"><a href="global.html#setupImageObserver">setupImageObserver</a></div><div class="sidebar-section-children"><a href="global.html#setupReelsObserver">setupReelsObserver</a></div><div class="sidebar-section-children"><a href="global.html#setupZoom">setupZoom</a></div><div class="sidebar-section-children"><a href="global.html#showLikeAnimation">showLikeAnimation</a></div><div class="sidebar-section-children"><a href="global.html#toggleLike">toggleLike</a></div><div class="sidebar-section-children"><a href="global.html#toggleSidebar">toggleSidebar</a></div></div></div></div></div><div class="navbar-container" id="VuAckcnZhf"><nav class="navbar"><div class="navbar-left-items"><div class="menu-item navbar-item"><a id="website_link" href="../index.html" target="_blank">Website</a></div></div><div class="navbar-right-items"><div class="navbar-right-item"><button class="icon-button search-button" aria-label="open-search"><svg><use xlink:href="#search-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button theme-toggle" aria-label="toggle-theme"><svg><use class="theme-svg-use" xlink:href="#light-theme-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button font-size" aria-label="change-font-size"><svg><use xlink:href="#font-size-icon"></use></svg></button></div></div><nav></nav></nav></div><div class="toc-container"><div class="toc-content"><span class="bold">On this page</span><div id="eed4d2a0bfd64539bb9df78095dec881"></div></div></div><div class="body-wrapper"><div class="main-content"><div class="main-wrapper"><section id="source-page" class="source-page"><header><h1 id="title" class="has-anchor">screens_reels.js</h1></header><article><pre class="prettyprint source lang-js"><code>
import { POSTS_DATA } from '../data/posts.js';
import { PINTEREST_MEDIA } from '../data/pinterest_data.js';
import { PHILOSOPHERS_DATA } from '../data/philosophers.js';
import { popupManager } from '../ui/PopupManager.js';

let lastTap = 0; // Para detectar o toque duplo
let isCleanView = false; // Estado global do modo limpo

/**
 * Renderiza todos os reels (imagens) na tela com Skeletons e Lazy Loading.
 * @param {object} gameState - O estado atual do jogo para verificar interações.
 */
function renderReels(gameState) {
    const reelsContainer = document.getElementById('reels-container');
    const loader = document.getElementById('reels-loader');
    if (!reelsContainer || !loader) return;

    reelsContainer.innerHTML = `
        &lt;div class="reels-header" style="position: absolute; top: 10px; right: 10px; z-index: 100;">
            &lt;button id="reels-settings-btn" class="action-button-secondary" style="background: rgba(0,0,0,0.5); color: white; border: none; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                &lt;i class="fas fa-cog">&lt;/i>
            &lt;/button>
        &lt;/div>
    `;

    document.getElementById('reels-settings-btn').addEventListener('click', () => {
        popupManager.open('reels:settings');
    });

    loader.style.display = 'flex'; // Mostra o skeleton

    // Simula um carregamento de rede
    setTimeout(() => {
        // Merge existing posts with Pinterest media
        let allPosts = [...POSTS_DATA, ...PINTEREST_MEDIA];

        // --- LÓGICA DE HISTÓRICO DE VISUALIZAÇÃO ---
        const seenReels = JSON.parse(localStorage.getItem('seenReels') || '[]');

        // Filtra posts que já foram vistos
        allPosts = allPosts.filter(post => !seenReels.includes(post.id));

        // Se não houver mais posts novos, mostra mensagem ou opção de resetar
        if (allPosts.length === 0) {
            reelsContainer.innerHTML = `
                &lt;div class="no-more-reels">
                    &lt;i class="fas fa-check-circle">&lt;/i>
                    &lt;p>Você já viu tudo por enquanto!&lt;/p>
                    &lt;button id="reset-history-btn" class="action-button">Ver Novamente&lt;/button>
                &lt;/div>
            `;
            loader.style.display = 'none';

            document.getElementById('reset-history-btn').addEventListener('click', () => {
                localStorage.removeItem('seenReels');
                renderReels(gameState); // Recarrega
            });
            return;
        }

        // Shuffle/Sort logic could go here if needed. For now, just appending.
        // Let's shuffle them a bit to mix them up
        allPosts.sort(() => Math.random() - 0.5);

        allPosts.forEach(post => {
            const philosopher = PHILOSOPHERS_DATA[post.philosopherId];
            if (!philosopher) return;

            const reelElement = document.createElement('div');
            reelElement.className = 'reel-item';
            reelElement.dataset.postId = post.id;

            // Aplica o estado global de clean view
            if (isCleanView) {
                reelElement.classList.add('clean-view');
            }

            const isLiked = gameState.userActions.likedPosts.includes(post.id);

            // Ponto 3: Acessibilidade (alt text e aria-labels)
            const captionExcerpt = post.caption.substring(0, 50).replace(/"/g, "'") + '...';
            const altText = `Reel por ${philosopher.name}: ${captionExcerpt}`;

            reelElement.innerHTML = `
                &lt;!-- Ponto 8: Contêiner para gesto de toque duplo e zoom -->
                &lt;div class="reel-media-container" style="background-color: white;">
                    &lt;!-- Ponto 2: Lazy loading com data-src -->
                    ${post.type === 'video'
                    ? `&lt;video class="reel-image" data-src="${post.mediaUrl}" loop playsinline controls>&lt;/video>`
                    : `&lt;img class="reel-image" data-src="${post.mediaUrl}" alt="${altText}" />`
                }
                    &lt;i class="fas fa-heart like-heart-animation">&lt;/i>
                &lt;/div>
                
                &lt;!-- Info na Parte Inferior -->
                &lt;div class="reel-bottom-info">
                    &lt;div class="reel-info" data-philosopher-id="${post.philosopherId}">
                        &lt;img src="${philosopher.image}" alt="${philosopher.name}" class="reel-avatar">
                        &lt;div class="reel-text-info">
                            &lt;strong>@${philosopher.name.toLowerCase().replace(/\s+/g, '_')}&lt;/strong>
                            &lt;p class="reel-caption-text">${post.caption}&lt;/p>
                        &lt;/div>
                    &lt;/div>
                &lt;/div>

                &lt;!-- Sidebar de Ações (separado do overlay de info) -->
                &lt;div class="reel-actions-sidebar">
                    &lt;button class="action-btn like-btn ${isLiked ? 'liked' : ''}" data-post-id="${post.id}" aria-label="Curtir post de ${philosopher.name}">
                        &lt;i class="fas fa-heart">&lt;/i>
                        &lt;span>${post.likes}&lt;/span>
                    &lt;/button>
                    &lt;!-- Ponto 5: Ação para comentários (abre popup) -->
                    &lt;button class="action-btn comment-btn" data-post-id="${post.id}" aria-label="Ver comentários">
                        &lt;i class="fas fa-comment-dots">&lt;/i>
                        &lt;span>${post.comments.length}&lt;/span>
                    &lt;/button>
                    &lt;!-- Ponto 7: Botão de compartilhamento real -->
                    &lt;button class="action-btn share-btn" data-post-id="${post.id}" aria-label="Compartilhar post">
                        &lt;i class="fas fa-share-square">&lt;/i>
                    &lt;/button>
                &lt;/div>`;

            reelsContainer.appendChild(reelElement);
        });

        loader.style.display = 'none'; // Esconde o skeleton
        setupImageObserver();
        setupZoom();
    }, 1000); // Atraso de 1s para visualizar o loader
}

/**
 * Configura a funcionalidade de Pinch-to-Zoom para as imagens dos reels.
 */
function setupZoom() {
    const mediaContainers = document.querySelectorAll('.reel-media-container');

    mediaContainers.forEach(container => {
        const img = container.querySelector('.reel-image');
        if (!img || img.tagName === 'VIDEO') return; // Zoom apenas em imagens por enquanto

        let initialDistance = 0;
        let currentScale = 1;
        let isPinching = false;

        container.addEventListener('touchstart', (e) => {
            if (e.touches.length === 2) {
                isPinching = true;
                initialDistance = getDistance(e.touches[0], e.touches[1]);
            }
        }, { passive: false });

        container.addEventListener('touchmove', (e) => {
            if (isPinching &amp;&amp; e.touches.length === 2) {
                e.preventDefault(); // Previne scroll enquanto dá zoom
                const newDistance = getDistance(e.touches[0], e.touches[1]);
                const scaleChange = newDistance / initialDistance;

                // Limita o zoom entre 1x e 3x
                let newScale = currentScale * scaleChange;
                newScale = Math.min(Math.max(1, newScale), 3);

                img.style.transform = `scale(${newScale})`;
                img.style.transition = 'none'; // Remove transição para resposta imediata
            }
        }, { passive: false });

        container.addEventListener('touchend', (e) => {
            if (isPinching &amp;&amp; e.touches.length &lt; 2) {
                isPinching = false;
                currentScale = 1; // Reseta o zoom ao soltar
                img.style.transform = `scale(1)`;
                img.style.transition = 'transform 0.3s ease'; // Suaviza o retorno
            }
        });
    });
}

function getDistance(touch1, touch2) {
    const dx = touch1.clientX - touch2.clientX;
    const dy = touch1.clientY - touch2.clientY;
    return Math.sqrt(dx * dx + dy * dy);
}

/**
 * Configura Intersection Observer para lazy loading e preloading de imagens.
 */
function setupImageObserver() {
    const reels = document.querySelectorAll('.reel-item');

    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            const img = entry.target.querySelector('.reel-image');
            if (!img) return;

            if (entry.isIntersecting) {
                // Ponto 2: Lazy Loading - Carrega a imagem visível
                if (img.dataset.src) {
                    img.src = img.dataset.src;
                    img.removeAttribute('data-src');
                }

                // Ponto 2: Preloading - Carrega a próxima e a anterior
                preloadAdjacentImages(entry.target);
            }
        });
    }, { threshold: 0.5 });

    reels.forEach(reel => observer.observe(reel));

    // --- OBSERVER PARA MARCAR COMO VISTO ---
    const seenObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const reelElement = entry.target;
                const postId = parseInt(reelElement.dataset.postId);

                if (postId) {
                    const seenReels = JSON.parse(localStorage.getItem('seenReels') || '[]');
                    if (!seenReels.includes(postId)) {
                        seenReels.push(postId);
                        localStorage.setItem('seenReels', JSON.stringify(seenReels));
                    }
                }

                // Para de observar após marcar como visto
                seenObserver.unobserve(reelElement);
            }
        });
    }, { threshold: 0.6 }); // Considera visto quando 60% estiver visível

    reels.forEach(reel => seenObserver.observe(reel));
}

/**
 * Pré-carrega as imagens do reel adjacente (próximo e anterior).
 * @param {HTMLElement} currentReelElement O elemento do reel atual.
 */
function preloadAdjacentImages(currentReelElement) {
    const nextReel = currentReelElement.nextElementSibling;
    const prevReel = currentReelElement.previousElementSibling;

    const preload = (element) => {
        if (!element) return;
        const imgToPreload = element.querySelector('.reel-image[data-src]');
        if (imgToPreload) {
            // Cria um objeto de imagem em memória para forçar o download e cache
            if (imgToPreload.tagName === 'IMG') {
                const img = new Image();
                img.src = imgToPreload.dataset.src;
            } else if (imgToPreload.tagName === 'VIDEO') {
                // For video, we can just set the src to start buffering if we wanted, 
                // but for now let's just leave it to the intersection observer
            }
        }
    };

    preload(nextReel);
    preload(prevReel);
}

/**
 * Mostra a animação de coração no centro da imagem.
 * @param {HTMLElement} mediaContainer O contêiner da mídia.
 */
function showLikeAnimation(mediaContainer) {
    const heart = mediaContainer.querySelector('.like-heart-animation');
    if (heart) {
        heart.classList.add('show');
        setTimeout(() => {
            heart.classList.remove('show');
        }, 800);
    }
}

/**
 * Lógica para curtir/descurtir um post.
 * @param {number} postId ID do post.
 * @param {object} gameState O estado do jogo.
 */
function toggleLike(postId, gameState) {
    const post = POSTS_DATA.find(p => p.id === postId);
    const likeBtn = document.querySelector(`.like-btn[data-post-id="${postId}"]`);
    if (!post || !likeBtn) return;

    const likeCount = likeBtn.querySelector('span');
    const isLiked = gameState.userActions.likedPosts.includes(postId);

    if (isLiked) {
        // Descurtir
        gameState.userActions.likedPosts = gameState.userActions.likedPosts.filter(id => id !== postId);
        post.likes--;
        likeBtn.classList.remove('liked');
    } else {
        // Curtir
        gameState.userActions.likedPosts.push(postId);
        post.likes++;
        likeBtn.classList.add('liked');
        // Mostra animação apenas ao curtir
        const mediaContainer = likeBtn.closest('.reel-item').querySelector('.reel-media-container');
        showLikeAnimation(mediaContainer);
    }
    likeCount.textContent = post.likes;
}


/**
 * Inicializa a tela de Reels.
 * @param {object} gameState - O estado atual do jogo.
 */
/**
 * Initializes the Reels Screen.
 * Triggers the rendering of the reels feed.
 * @module Screens/Reels
 * @param {object} gameState - The global game state.
 */
export function initReelsScreen(gameState) {
    renderReels(gameState);
}

/**
 * Manipulador de cliques e toques para a tela de Reels.
 * @param {Event} event - O objeto do evento.
 * @param {object} gameState - O estado atual do jogo.
 * @param {object} toast - A instância do Toast para notificações.
 */
/**
 * Handles click and tap events on the Reels Screen.
 * Supports double-tap to like, and buttons for like, comment, and share.
 * @param {Event} event - The event object.
 * @param {object} gameState - The global game state.
 * @param {object} toast - Toast notification utility.
 */
export function handleReelsScreenClick(event, gameState, toast) {
    const target = event.target;

    // Ponto 8: Gesto de toque duplo para curtir + Toggle de visibilidade
    const mediaContainer = target.closest('.reel-media-container');
    if (mediaContainer) {
        const currentTime = new Date().getTime();
        const timeSinceLastTap = currentTime - lastTap;

        if (timeSinceLastTap &lt; 300 &amp;&amp; timeSinceLastTap > 0) {
            // Duplo clique em 300ms - CURTIR
            const postId = parseInt(mediaContainer.closest('.reel-item').dataset.postId);
            const isLiked = gameState.userActions.likedPosts.includes(postId);
            if (!isLiked) {
                toggleLike(postId, gameState);
            } else {
                showLikeAnimation(mediaContainer); // Mostra a animação mesmo se já estiver curtido
            }
        } else {
            // Clique simples - TOGGLE VISIBILIDADE (com delay para distinguir de duplo clique)
            setTimeout(() => {
                const timeSinceThisTap = new Date().getTime() - currentTime;
                // Se passou mais de 300ms sem outro clique, é um clique simples
                if (timeSinceThisTap >= 300) {
                    // Alterna o estado global
                    isCleanView = !isCleanView;

                    // Aplica o estado a todos os reels
                    const allReels = document.querySelectorAll('.reel-item');
                    allReels.forEach(reel => {
                        if (isCleanView) {
                            reel.classList.add('clean-view');
                        } else {
                            reel.classList.remove('clean-view');
                        }
                    });
                }
            }, 300);
        }

        lastTap = currentTime;
        return;
    }

    // Ação de curtir (botão)
    const likeBtn = target.closest('.like-btn');
    if (likeBtn) {
        const postId = parseInt(likeBtn.dataset.postId);
        toggleLike(postId, gameState);
        return;
    }

    // Ponto 5: Comentários (com suporte a threads em uma implementação futura)
    const commentBtn = target.closest('.comment-btn');
    if (commentBtn) {
        const postId = parseInt(commentBtn.dataset.postId);
        // O popupManager agora pode receber dados para renderizar comentários,
        // incluindo respostas, formando threads.
        popupManager.open('comments', { postId: postId });
        return;
    }

    // Ponto 7: Funcionalidade de compartilhamento real
    const shareBtn = target.closest('.share-btn');
    if (shareBtn) {
        const postId = parseInt(shareBtn.dataset.postId);
        const post = POSTS_DATA.find(p => p.id === postId);
        const philosopher = PHILOSOPHERS_DATA[post.philosopherId];

        const shareData = {
            title: `LOGOS: Um reel de ${philosopher.name}`,
            text: post.caption,
            url: window.location.href // Em um app real, seria um link direto para o post
        };

        if (navigator.share &amp;&amp; navigator.canShare(shareData)) {
            navigator.share(shareData)
                .catch(err => console.error('Erro ao compartilhar:', err));
        } else {
            // Fallback para desktop ou navegadores sem suporte
            navigator.clipboard.writeText(shareData.url).then(() => {
                toast.show('Link copiado para a área de transferência!', 'success');
            });
        }
        return;
    }

    // Ponto 6: Abrir página de perfil do filósofo
    const reelInfo = target.closest('.reel-info');
    if (reelInfo &amp;&amp; reelInfo.dataset.philosopherId) {
        const philosopherId = reelInfo.dataset.philosopherId;
        // Aqui, em vez de um popup, você poderia navegar para uma nova "tela"
        // que mostraria todos os posts e informações do filósofo.
        // Usando o popupManager como simulação:
        popupManager.open('philosopher-profile', { philosopherId: philosopherId });
        return;
    }
}</code></pre></article></section></div></div></div><div class="search-container" id="PkfLWpAbet" style="display:none"><div class="wrapper" id="iCxFxjkHbP"><button class="icon-button search-close-button" id="VjLlGakifb" aria-label="close search"><svg><use xlink:href="#close-icon"></use></svg></button><div class="search-box-c"><svg><use xlink:href="#search-icon"></use></svg> <input type="text" id="vpcKVYIppa" class="search-input" placeholder="Search..." autofocus></div><div class="search-result-c" id="fWwVHRuDuN"><span class="search-result-c-text">Type anything to view search result</span></div></div></div><div class="mobile-menu-icon-container"><button class="icon-button" id="mobile-menu" data-isopen="false" aria-label="menu"><svg><use xlink:href="#menu-icon"></use></svg></button></div><div id="mobile-sidebar" class="mobile-sidebar-container"><div class="mobile-sidebar-wrapper"><a href="/" class="sidebar-title sidebar-title-anchor">LOGOS Documentation</a><div class="mobile-nav-links"><div class="menu-item navbar-item"><a id="website_link-mobile" href="../index.html" target="_blank">Website</a></div></div><div class="mobile-sidebar-items-c"><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-modules"><div>Modules</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="module-Screens_Library.html">Screens/Library</a></div><div class="sidebar-section-children"><a href="module-Screens_Login.html">Screens/Login</a></div><div class="sidebar-section-children"><a href="module-Screens_Philosophers.html">Screens/Philosophers</a></div><div class="sidebar-section-children"><a href="module-Screens_Play.html">Screens/Play</a></div><div class="sidebar-section-children"><a href="module-Screens_Reels.html">Screens/Reels</a></div><div class="sidebar-section-children"><a href="module-Screens_SchoolMembers.html">Screens/SchoolMembers</a></div><div class="sidebar-section-children"><a href="module-Screens_Schools.html">Screens/Schools</a></div><div class="sidebar-section-children"><a href="module-Screens_Shop.html">Screens/Shop</a></div><div class="sidebar-section-children"><a href="module-Screens_Symposium.html">Screens/Symposium</a></div><div class="sidebar-section-children"><a href="module-Services_Auth.html">Services/Auth</a></div><div class="sidebar-section-children"><a href="module-Services_Database.html">Services/Database</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-classes"><div>Classes</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="Card.html">Card</a></div><div class="sidebar-section-children"><a href="Modal.html">Modal</a></div><div class="sidebar-section-children"><a href="Player.html">Player</a></div><div class="sidebar-section-children"><a href="PopupManager.html">PopupManager</a></div><div class="sidebar-section-children"><a href="Toast.html">Toast</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-namespaces"><div>Namespaces</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="AnimationsModule.html">AnimationsModule</a></div><div class="sidebar-section-children"><a href="Data.html">Data</a></div><div class="sidebar-section-children"><a href="Data.html">Data</a></div><div class="sidebar-section-children"><a href="Data.html">Data</a></div><div class="sidebar-section-children"><a href="Data.html">Data</a></div><div class="sidebar-section-children"><a href="Data.html">Data</a></div><div class="sidebar-section-children"><a href="Data.html">Data</a></div><div class="sidebar-section-children"><a href="Data.html">Data</a></div><div class="sidebar-section-children"><a href="Data.html">Data</a></div><div class="sidebar-section-children"><a href="Data.html">Data</a></div><div class="sidebar-section-children"><a href="EngineModule.html">EngineModule</a></div><div class="sidebar-section-children"><a href="EventsModule.html">EventsModule</a></div><div class="sidebar-section-children"><a href="GameUI.html">GameUI</a></div><div class="sidebar-section-children"><a href="Popups.html">Popups</a></div><div class="sidebar-section-children"><a href="RendererModule.html">RendererModule</a></div><div class="sidebar-section-children"><a href="StateModule.html">StateModule</a></div><div class="sidebar-section-children"><a href="Utils.html">Utils</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-global"><div>Global</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="global.html#ArenaTimelinePopup">ArenaTimelinePopup</a></div><div class="sidebar-section-children"><a href="global.html#ChestInfoPopup">ChestInfoPopup</a></div><div class="sidebar-section-children"><a href="global.html#ChestRewardsPopup">ChestRewardsPopup</a></div><div class="sidebar-section-children"><a href="global.html#DESKTOP_BREAKPOINT">DESKTOP_BREAKPOINT</a></div><div class="sidebar-section-children"><a href="global.html#FullProfilePopup">FullProfilePopup</a></div><div class="sidebar-section-children"><a href="global.html#LevelXpPopup">LevelXpPopup</a></div><div class="sidebar-section-children"><a href="global.html#PhilosopherDetailsPopup">PhilosopherDetailsPopup</a></div><div class="sidebar-section-children"><a href="global.html#PhilosopherStudyModulePopup">PhilosopherStudyModulePopup</a></div><div class="sidebar-section-children"><a href="global.html#ReelsSettingsPopup">ReelsSettingsPopup</a></div><div class="sidebar-section-children"><a href="global.html#SCHOOLS">SCHOOLS</a></div><div class="sidebar-section-children"><a href="global.html#SettingsPopup">SettingsPopup</a></div><div class="sidebar-section-children"><a href="global.html#TimedChestInfoPopup">TimedChestInfoPopup</a></div><div class="sidebar-section-children"><a href="global.html#handleResize">handleResize</a></div><div class="sidebar-section-children"><a href="global.html#initLayoutManager">initLayoutManager</a></div><div class="sidebar-section-children"><a href="global.html#isDesktopView">isDesktopView</a></div><div class="sidebar-section-children"><a href="global.html#preloadAdjacentImages">preloadAdjacentImages</a></div><div class="sidebar-section-children"><a href="global.html#renderMembers">renderMembers</a></div><div class="sidebar-section-children"><a href="global.html#renderPosts">renderPosts</a></div><div class="sidebar-section-children"><a href="global.html#renderReels">renderReels</a></div><div class="sidebar-section-children"><a href="global.html#setupImageObserver">setupImageObserver</a></div><div class="sidebar-section-children"><a href="global.html#setupReelsObserver">setupReelsObserver</a></div><div class="sidebar-section-children"><a href="global.html#setupZoom">setupZoom</a></div><div class="sidebar-section-children"><a href="global.html#showLikeAnimation">showLikeAnimation</a></div><div class="sidebar-section-children"><a href="global.html#toggleLike">toggleLike</a></div><div class="sidebar-section-children"><a href="global.html#toggleSidebar">toggleSidebar</a></div></div></div><div class="mobile-navbar-actions"><div class="navbar-right-item"><button class="icon-button search-button" aria-label="open-search"><svg><use xlink:href="#search-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button theme-toggle" aria-label="toggle-theme"><svg><use class="theme-svg-use" xlink:href="#light-theme-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button font-size" aria-label="change-font-size"><svg><use xlink:href="#font-size-icon"></use></svg></button></div></div></div></div><script type="text/javascript" src="scripts/core.min.js"></script><script src="scripts/search.min.js" defer="defer"></script><script src="scripts/third-party/fuse.js" defer="defer"></script><script type="text/javascript">var tocbotInstance=tocbot.init({tocSelector:"#eed4d2a0bfd64539bb9df78095dec881",contentSelector:".main-content",headingSelector:"h1, h2, h3",hasInnerContainers:!0,scrollContainer:".main-content",headingsOffset:130,onClick:bringLinkToView})</script>
    <div style="position: fixed; bottom: 20px; right: 20px; z-index: 1000;">
        <button onclick="var m=document.getElementById('dl-menu'); m.style.display = m.style.display === 'none' ? 'block' : 'none'" 
                style="background: #444; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.5);">
            Download Options
        </button>
        <div id="dl-menu" style="display: none; position: absolute; bottom: 100%; right: 0; background: #333; border: 1px solid #555; border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.5); min-width: 160px; margin-bottom: 10px; overflow: hidden;">
            <a href="#" onclick="window.print(); return false;" style="display: block; padding: 10px; color: #eee; text-decoration: none; border-bottom: 1px solid #444;">Save as PDF</a>
            <a href="documentation.md" download="LOGOS_Docs.md" style="display: block; padding: 10px; color: #eee; text-decoration: none; border-bottom: 1px solid #444;">Download Markdown</a>
            <a href="data.json" download="LOGOS_Data.json" style="display: block; padding: 10px; color: #eee; text-decoration: none;">Download JSON</a>
        </div>
    </div>
    </body></html>